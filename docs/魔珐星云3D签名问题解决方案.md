# 魔珐星云3D数字人API签名问题解决方案

## 问题描述

在集成魔珐星云3D数字人视频合成API时，遇到持续的"签名有误"错误。经过分析，发现问题的根本原因是：

**魔珐星云API要求JSON数据中的所有非ASCII字符（如中文）必须转义为Unicode格式（\uXXXX）才能正确计算MD5签名。**

## 问题根因

### 签名算法要求

魔珐星云API的签名计算公式：
```
MD5(lower_api_path + lower_method + sorted_json_str + secret + timestamp)
```

其中`sorted_json_str`必须满足：
1. 所有key按字母顺序排序
2. 没有空格
3. **所有非ASCII字符转义为Unicode格式** (\uXXXX)

### Python vs Java的差异

Python的`json.dumps(data, sort_keys=True, ensure_ascii=True)`会自动将中文转义为Unicode：
```python
# Python输出
{"text":"\\u5927\\u5bb6\\u597d"}  # "大家好" -> Unicode转义
```

但Java的fastjson2即使使用`BrowserCompatible`特性也无法实现相同的转义效果：
```java
// Java输出（错误）
{"text":"大家好"}  # 未转义
```

## 解决方案

### 核心代码改动

在`Xingyun3dSignatureUtil.java`中添加自定义Unicode转义方法：

```java
/**
 * 手动将字符串中的非ASCII字符转义为Unicode序列
 */
private static String escapeNonAscii(String input) {
    if (input == null) {
        return null;
    }
    StringBuilder sb = new StringBuilder();
    for (int i = 0; i < input.length(); i++) {
        char c = input.charAt(i);
        if (c > 127) {
            // 非ASCII字符，转义为unicode格式（反斜杠u加四位十六进制）
            sb.append(String.format("\\u%04x", (int) c));
        } else {
            sb.append(c);
        }
    }
    return sb.toString();
}
```

### 签名生成流程

```java
public static String generateToken(String apiPath, String method, Object data, String secret, Long timestamp) {
    // 1. 转换api_path为小写
    String lowerApiPath = apiPath != null ? apiPath.toLowerCase() : "";

    // 2. 转换method为小写
    String lowerMethod = method != null ? method.toLowerCase() : "";

    // 3. 序列化数据并转义非ASCII字符
    String sortJsonStr = "";
    if (data != null) {
        // 使用fastjson2排序所有key
        String jsonStr = JSON.toJSONString(data,
            com.alibaba.fastjson2.JSONWriter.Feature.MapSortField
        ).replace(" ", "");

        // 手动转义所有非ASCII字符为Unicode序列
        sortJsonStr = escapeNonAscii(jsonStr);
    }

    // 4. 拼接签名字符串
    String signStr = lowerApiPath + lowerMethod + sortJsonStr + secret + timestamp;

    // 5. 计算MD5
    String token = DigestUtil.md5Hex(signStr);

    return token;
}
```

## 测试结果

### 修复前
```
API响应: {"error_code":1,"error_reason":"签名有误"}
```

### 修复后
```
API响应: {"error_code":0,"error_reason":"","data":{"task_id":582}}
```

任务ID: 582 成功创建！

## 示例对比

### 转义前后的JSON对比

**转义前（错误）：**
```json
{"text":"<speak>大家好！欢迎来到毕方智映的产品介绍会。"}
```

**转义后（正确）：**
```json
{"text":"<speak>\\u5927\\u5bb6\\u597d\\uff01\\u6b22\\u8fce\\u6765\\u5230\\u6bd5\\u65b9\\u667a\\u6620\\u7684\\u4ea7\\u54c1\\u4ecb\\u7ecd\\u4f1a\\u3002"}
```

## 关键文件

1. **签名工具类**
   - 文件：`yudao-module-digitalcourse-biz/src/main/java/.../xingyun3d/Xingyun3dSignatureUtil.java`
   - 修改：添加`escapeNonAscii()`方法

2. **API客户端**
   - 文件：`yudao-module-digitalcourse-biz/src/main/java/.../xingyun3d/Xingyun3dClient.java`
   - 使用：调用`Xingyun3dSignatureUtil.generateToken()`生成签名

## 编译和部署

### 完整构建流程

```bash
# 1. 清理并安装到本地仓库
cd easegen-admin
mvn clean install -pl yudao-module-digitalcourse/yudao-module-digitalcourse-biz -am -DskipTests

# 2. 启动服务器
cd yudao-server
mvn spring-boot:run -Dspring-boot.run.profiles=local
```

### 重要提示

如果修改了`Xingyun3dSignatureUtil.java`，**必须使用`mvn clean install`而不是`mvn compile`**，以确保JAR被正确安装到Maven本地仓库，否则可能出现类加载问题导致旧代码仍在运行。

## 总结

1. **问题根源**：魔珐星云API的签名算法要求JSON中的中文必须转义为Unicode格式
2. **解决方法**：自定义`escapeNonAscii()`方法手动转义所有非ASCII字符
3. **验证成功**：API返回`error_code=0`，任务创建成功
4. **部署注意**：必须使用`mvn clean install`确保新代码被加载

---

**日期**: 2025-11-07
**作者**: Claude Code
**版本**: 1.0
